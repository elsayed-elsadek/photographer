;/*FB_PKG_DELIM*/

__d("LSDeleteMessage",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.forEach(b.filter(b.db.table(12).fetch([[[a[1]]],"messageId"]),function(c){return c.messageId===a[1]&&b.i64.eq(c.threadKey,a[0])}),function(a){return a["delete"]()})},function(a){return b.resolve(c)}])}a.__sproc_name__="LSMailboxDeleteMessageStoredProcedure";a.__tables__=["messages"];e.exports=a}),null);
__d("LSDeleteThenInsertMessage",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.db.table(12).fetch([[[a[9]]],"optimistic"]).next().then(function(c,d){var e=c.done;c=c.value;return e?b.db.table(12).add({threadKey:a[3],timestampMs:a[5],messageId:a[8],offlineThreadingId:a[9],authorityLevel:a[2],primarySortKey:a[6],senderId:a[10],isAdminMessage:a[12],sendStatus:a[15],sendStatusV2:a[16],text:a[0],subscriptErrorMessage:a[1],secondarySortKey:a[7],stickerId:a[11],messageRenderingType:a[13],isUnsent:a[17],unsentTimestampMs:a[18],mentionOffsets:a[19],mentionLengths:a[20],mentionIds:a[21],mentionTypes:a[22],replySourceId:a[23],replySourceType:a[24],replySourceTypeV2:a[25],replyStatus:a[26],replySnippet:a[27],replyMessageText:a[28],replyToUserId:a[29],replyMediaExpirationTimestampMs:a[30],replyMediaUrl:a[31],replyMediaPreviewWidth:a[33],replyMediaPreviewHeight:a[34],replyMediaUrlMimeType:a[35],replyMediaUrlFallback:a[36],replyCtaId:a[37],replyCtaTitle:a[38],replyAttachmentType:a[39],replyAttachmentId:a[40],replyAttachmentExtra:a[41],isForwarded:a[42],forwardScore:a[43],hasQuickReplies:a[44],adminMsgCtaId:a[45],adminMsgCtaTitle:a[46],adminMsgCtaType:a[47],cannotUnsendReason:a[48],textHasLinks:a[49],viewFlags:a[50],displayedContentTypes:a[51],viewedPluginKey:a[52],viewedPluginContext:a[53],quickReplyType:a[54],hotEmojiSize:a[55],platformXmdEncoded:a[56],replySourceTimestampMs:a[57],ephemeralDurationInSec:a[58],msUntilExpirationTs:a[59],ephemeralExpirationTs:a[60],takedownState:a[61],isCollapsed:a[62],subthreadKey:a[63],botResponseId:a[64],metadataDataclass:a[65],editCount:a[66],isPaidPartnership:a[67],adminSignatureName:a[68],adminSignatureProfileUrl:a[69],adminSignatureCreatorType:a[70],translatedText:a[71],textDialect:a[72],translatedTextDialect:a[73],scheduledTimestamp:a[74],isVideoQuickSend:a[75]}):(d=c.item,b.i64.le(d.authorityLevel,a[2])?b.db.table(12).put({threadKey:a[3],timestampMs:a[5],messageId:a[8],offlineThreadingId:a[9],authorityLevel:a[2],primarySortKey:d.primarySortKey,senderId:a[10],isAdminMessage:a[12],sendStatus:a[15],sendStatusV2:a[16],text:a[0],subscriptErrorMessage:a[1],secondarySortKey:d.secondarySortKey,stickerId:a[11],messageRenderingType:a[13],isUnsent:a[17],unsentTimestampMs:a[18],mentionOffsets:a[19],mentionLengths:a[20],mentionIds:a[21],mentionTypes:a[22],replySourceId:a[23],replySourceType:a[24],replySourceTypeV2:a[25],replyStatus:a[26],replySnippet:a[27],replyMessageText:a[28],replyToUserId:a[29],replyMediaExpirationTimestampMs:a[30],replyMediaUrl:a[31],replyMediaPreviewWidth:a[33],replyMediaPreviewHeight:a[34],replyMediaUrlMimeType:a[35],replyMediaUrlFallback:a[36],replyCtaId:a[37],replyCtaTitle:a[38],replyAttachmentType:a[39],replyAttachmentId:a[40],replyAttachmentExtra:a[41],isForwarded:a[42],forwardScore:a[43],hasQuickReplies:a[44],adminMsgCtaId:a[45],adminMsgCtaTitle:a[46],adminMsgCtaType:a[47],cannotUnsendReason:a[48],textHasLinks:a[49],viewFlags:a[50],displayedContentTypes:a[51],viewedPluginKey:a[52],viewedPluginContext:a[53],quickReplyType:a[54],hotEmojiSize:a[55],platformXmdEncoded:a[56],replySourceTimestampMs:a[57],ephemeralDurationInSec:a[58],msUntilExpirationTs:a[59],ephemeralExpirationTs:a[60],takedownState:a[61],isCollapsed:a[62],subthreadKey:a[63],botResponseId:a[64],metadataDataclass:a[65],editCount:a[66],isPaidPartnership:a[67],adminSignatureName:a[68],adminSignatureProfileUrl:a[69],adminSignatureCreatorType:a[70],translatedText:a[71],textDialect:a[72],translatedTextDialect:a[73],scheduledTimestamp:a[74],isVideoQuickSend:a[75]}):b.resolve())})},function(a){return b.resolve(c)}])}a.__sproc_name__="LSMailboxDeleteThenInsertMessageStoredProcedure";a.__tables__=["messages"];e.exports=a}),null);
__d("LSHandleRepliesOnRemove",["LSDeleteMessage"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[];return c.sequence([function(d){return c.sequence([function(d){return c.forEach(c.filter(c.db.table(12).fetch([[[a[1]]],"replySourceIdMessageID"]),function(b){return c.i64.eq(b.threadKey,a[0])&&b.replySourceId===a[1]&&c.i64.eq(b.replyType,c.i64.cast([0,1]))}),function(a){a=a.item;return c.storedProcedure(b("LSDeleteMessage"),a.threadKey,a.messageId)})},function(b){return c.forEach(c.filter(c.db.table(12).fetch([[[a[1]]],"replySourceIdMessageID"]),function(b){return c.i64.eq(b.threadKey,a[0])&&b.replySourceId===a[1]}),function(a){var b=a.item;return c.forEach(c.filter(c.db.table(12).fetch([[[b.threadKey,b.timestampMs,b.messageId]]]),function(a){return c.i64.eq(a.threadKey,b.threadKey)&&c.i64.eq(c.i64.cast([0,0]),c.i64.cast([0,0]))&&c.i64.eq(a.timestampMs,b.timestampMs)&&a.messageId===b.messageId}),function(a){var b=a.update;a.item;return b({replySourceId:void 0,replySourceTimestampMs:void 0,replySourceType:void 0,replySourceTypeV2:void 0,replySnippet:void 0,replyStatus:void 0,replyToUserId:void 0,replyMessageText:void 0,replyMediaExpirationTimestampMs:void 0,replyMediaUrl:void 0,replyMediaUrlFallback:void 0,replyMediaPreviewWidth:void 0,replyMediaPreviewHeight:void 0,replyMediaUrlMimeType:void 0,replyAttachmentType:void 0,replyAttachmentId:void 0,replyAttachmentExtra:void 0})})})}])},function(a){return c.resolve(d)}])}a.__sproc_name__="LSMailboxHandleRepliesOnRemoveStoredProcedure";a.__tables__=["messages"];e.exports=a}),null);
__d("LSRefreshLastActivityTimestamp",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[],d=[];return b.sequence([function(d){return b.sequence([function(d){return b.db.table(12).fetchDesc([[[a[0]]]]).next().then(function(a,d){var e=a.done;a=a.value;return e?c[0]=b.i64.cast([0,0]):(d=a.item,c[0]=d.timestampMs)})},function(d){return b.db.table(9).fetch([[[a[0]]]]).next().then(function(a,d){var e=a.done;a=a.value;return e?c[2]=b.i64.cast([0,0]):(d=a.item,c[2]=d.lastActivityTimestampMs)})},function(d){return b.i64.neq(c[0],b.i64.cast([0,0]))&&b.i64.neq(c[0],c[2])?b.forEach(b.db.table(9).fetch([[[a[0]]]]),function(a){var b=a.update;a.item;return b({lastActivityTimestampMs:c[0]})}):b.resolve()}])},function(a){return b.resolve(d)}])}a.__sproc_name__="LSMailboxRefreshLastActivityTimestampStoredProcedure";a.__tables__=["messages","threads"];e.exports=a}),null);
__d("LSSetPinnedMessage",["LSIssueNewTask"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=new c.Map(),d[0].set("thread_key",a[0]),d[0].set("message_id",a[1]),d[0].set("pinned_message_state",a[3]),d[1]=c.toJSON(d[0]),c.storedProcedure(b("LSIssueNewTask"),"set_pinned_message_search",c.i64.cast([0,751]),d[1],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))},function(b){return c.i64.eq(a[3],c.i64.cast([0,1]))?c.sequence([function(b){return c.forEach(c.db.table(205).fetch([[[a[0],a[1]]]]),function(a){return a["delete"]()})},function(b){return c.forEach(c.filter(c.db.table(205).fetch([[[a[0],a[1],a[2]]]]),function(b){return c.i64.eq(b.threadKey,a[0])&&b.messageId===a[1]&&c.i64.eq(b.pinnedTimestampMs,a[2])&&c.i64.lt(b.authorityLevel,c.i64.cast([0,80]))}),function(a){return a["delete"]()})},function(b){return c.db.table(205).add({threadKey:a[0],messageId:a[1],pinnedTimestampMs:a[2],authorityLevel:c.i64.cast([0,80])})}]):c.forEach(c.db.table(205).fetch([[[a[0],a[1]]]]),function(a){return a["delete"]()})}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSMailboxSetPinnedMessageStoredProcedure";a.__tables__=["msg_pinned_messages_v2"];e.exports=a}),null);
__d("LSUpdateThreadSnippetFromLastMessage",["LSGetThreadParticipantDisplayName","LSUpdateThreadSnippetFromLastMessageV2"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=!0,d[0]&&!a[11]?c.sequence([function(d){return c.storedProcedure(b("LSUpdateThreadSnippetFromLastMessageV2"),a[1])},function(a){return d[1]=!1}]):c.resolve(d[1]=!0)},function(e){return d[1]?c.db.table(12).fetchDesc([[[a[1]]]]).next().then(function(e,f){var g=e.done;e=e.value;return g?c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(a){var b=a.update;a.item;return b({snippet:void 0,snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:!1,snippetSenderContactId:void 0})}):(f=e.item,c.sequence([function(b){return d[5]=f.text,d[8]=f.threadKey,d[9]=c.i64.cast([0,0]),d[10]=f.messageId,d[12]=f.senderId,d[6]=f.stickerId,d[11]=f.isAdminMessage,d[7]=f.isUnsent,c.count(c.filter(c.db.table(9).fetch([[[a[1]]]]),function(b){return c.i64.eq(a[1],b.threadKey)&&c.i64.eq(c.i64.cast([0,2]),b.threadType)})).then(function(a){return d[3]=a})},function(b){return d[11]?c.resolve(d[4]=c.i64.cast([0,9])):c.sequence([function(b){return c.i64.eq(d[12],a[0])?c.sequence([function(a){return d[7]?c.resolve(d[14]=c.i64.cast([0,3])):c.sequence([function(a){return c.sequence([function(a){return d[5]!==void 0&&d[5]!==""?c.resolve(d[16]=c.i64.cast([0,0])):c.sequence([function(a){return c.i64.neq(d[6],void 0)?c.resolve(d[17]=c.i64.cast([0,2])):c.sequence([function(a){return c.filter(c.db.table(16).fetch([[[d[8],d[10]]]]),function(a){return c.i64.eq(a.threadKey,d[8])&&c.i64.eq(c.i64.cast([0,0]),d[9])&&a.messageId===d[10]}).next().then(function(b,e){var a=b.done;b=b.value;return a?d[18]=c.i64.cast([0,1]):(e=b.item,c.i64.eq(e.attachmentType,c.i64.cast([0,2]))?d[20]=c.i64.cast([0,10]):d[20]=c.i64.cast([0,1]),d[18]=d[20])})},function(a){return d[17]=d[18]}])},function(a){return d[16]=d[17]}])},function(a){return d[15]=d[16]}])},function(a){return d[14]=d[15]}])},function(a){return d[13]=d[14]}]):c.sequence([function(a){return d[7]?c.resolve(d[14]=c.i64.cast([0,8])):c.sequence([function(a){return c.sequence([function(a){return d[5]!==void 0&&d[5]!==""?c.resolve((c.i64.eq(d[3],c.i64.cast([0,1]))?d[17]=c.i64.cast([0,5]):d[17]=c.i64.cast([0,4]),d[16]=d[17])):c.sequence([function(a){return c.i64.neq(d[6],void 0)?c.resolve(d[17]=c.i64.cast([0,7])):c.sequence([function(a){return c.filter(c.db.table(16).fetch([[[d[8],d[10]]]]),function(a){return c.i64.eq(a.threadKey,d[8])&&c.i64.eq(c.i64.cast([0,0]),d[9])&&a.messageId===d[10]}).next().then(function(b,e){var a=b.done;b=b.value;return a?d[18]=c.i64.cast([0,6]):(e=b.item,c.i64.eq(e.attachmentType,c.i64.cast([0,2]))?d[20]=c.i64.cast([0,11]):d[20]=c.i64.cast([0,6]),d[18]=d[20])})},function(a){return d[17]=d[18]}])},function(a){return d[16]=d[17]}])},function(a){return d[15]=d[16]}])},function(a){return d[14]=d[15]}])},function(a){return d[13]=d[14]}])},function(a){return d[4]=d[13]}])},function(e){return c.i64.eq(d[4],c.i64.cast([0,0]))?(d[14]=d[5]===""?void 0:d[5],d[14]!==void 0?d[13]=[a[2],": ",d[14]].join(""):d[13]=void 0,c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(a){var b=a.update;a.item;return b({snippet:d[13],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:d[11],snippetSenderContactId:d[12]})})):c.i64.eq(d[4],c.i64.cast([0,1]))?c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(b){var c=b.update;b.item;return c({snippet:a[5],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:d[11],snippetSenderContactId:d[12]})}):c.i64.eq(d[4],c.i64.cast([0,10]))?c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(b){var c=b.update;b.item;return c({snippet:a[7],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:d[11],snippetSenderContactId:d[12]})}):c.i64.eq(d[4],c.i64.cast([0,2]))?c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(b){var c=b.update;b.item;return c({snippet:a[3],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:d[11],snippetSenderContactId:d[12]})}):c.i64.eq(d[4],c.i64.cast([0,3]))?c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(b){var c=b.update;b.item;return c({snippet:a[9],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:d[11],snippetSenderContactId:d[12]})}):c.i64.eq(d[4],c.i64.cast([0,4]))?c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(a){var b=a.update;a.item;return b({snippet:d[5],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:d[11],snippetSenderContactId:d[12]})}):c.i64.eq(d[4],c.i64.cast([0,5]))?c.sequence([function(e){return c.storedProcedure(b("LSGetThreadParticipantDisplayName"),a[1],d[12]).then(function(a){return a=a,d[13]=a[0],a})},function(b){return d[15]=d[5]===""?void 0:d[5],d[15]!==void 0?d[14]=[d[13],": ",d[15]].join(""):d[14]=void 0,c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(a){var b=a.update;a.item;return b({snippet:d[14],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:d[11],snippetSenderContactId:d[12]})})}]):c.i64.eq(d[4],c.i64.cast([0,6]))?c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(b){var c=b.update;b.item;return c({snippet:a[6],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:d[11],snippetSenderContactId:d[12]})}):c.i64.eq(d[4],c.i64.cast([0,11]))?c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(b){var c=b.update;b.item;return c({snippet:a[8],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:d[11],snippetSenderContactId:d[12]})}):c.i64.eq(d[4],c.i64.cast([0,7]))?c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(b){var c=b.update;b.item;return c({snippet:a[4],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:d[11],snippetSenderContactId:d[12]})}):c.i64.eq(d[4],c.i64.cast([0,8]))?c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(b){var c=b.update;b.item;return c({snippet:a[10],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:d[11],snippetSenderContactId:d[12]})}):c.i64.eq(d[4],c.i64.cast([0,9]))?c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(a){var b=a.update;a.item;return b({snippet:d[5],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:d[11],snippetSenderContactId:d[12]})}):c.i64.eq(d[4],c.i64.cast([0,12]))?c.forEach(c.db.table(9).fetch([[[a[1]]]]),function(a){var b=a.update;a.item;return b({snippet:"",snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,isAdminSnippet:d[11],snippetSenderContactId:d[12]})}):c.resolve(0)}]))}):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSMailboxUpdateThreadSnippetFromLastMessageStoredProcedure";a.__tables__=["messages","threads","attachments"];e.exports=a}),null);